<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>请假申请单</title>
        <!-- 引入样式 -->
        <link href="/assets/element-plus/index.css" rel="stylesheet" type="text/css">
        <!-- 引入组件库 -->
        <script src="/assets/vue/vue.global.js"></script>
        <script src="/assets/element-plus/index.full.js"></script>
        <script src="/assets/element-plus/locale/zh-cn.js"></script>
        <script src="/assets/axios/axios.js"></script>

        <style>
            .el-form {
                border: 1px solid #DCDFE6;
                width: 600px;
                margin: 180px auto;
                padding: 35px 35px 15px 35px;
                border-radius: 5px;
                -webkit-border-radius: 5px;
                -moz-border-radius: 5px;
                box-shadow: 0 0 25px #909399;
            }
        </style>

    </head>
    <body>
        <div id="app">
            <el-form :model="form" :rules="rules" label-width="80px" ref="leaveForm">
                <el-descriptions :column="1" border title="请假申请单">
                    <el-descriptions-item label="部门">
                        {{department.departmentName}}
                    </el-descriptions-item>
                    <el-descriptions-item label="申请人">
                        {{employee.name}}[{{employee.title}}]
                    </el-descriptions-item>
                    <el-descriptions-item label="请假类型">

                        <el-select style="width: 100%" v-model="form.formType">
                            <el-option label="事假" value="1"></el-option>
                            <el-option label="病假" value="2"></el-option>
                            <el-option label="工伤假" value="3"></el-option>
                            <el-option label="婚嫁" value="4"></el-option>
                            <el-option label="产假" value="5"></el-option>
                            <el-option label="丧假" value="6"></el-option>
                        </el-select>

                    </el-descriptions-item>
                    <el-descriptions-item label="请假时间">
                        <el-form-item label-width="0px" prop="timeRange">
                            <div class="block">
                                <el-date-picker
                                        @change="changeTimeRange"
                                        end-placeholder="结束日期"
                                        range-separator="至"
                                        start-placeholder="开始日期"
                                        type="datetimerange"
                                        v-model="form.timeRange">
                                </el-date-picker>
                            </div>
                        </el-form-item>
                    </el-descriptions-item>
                    <el-descriptions-item label="请假原因">
                        <el-form-item label-width="0px" prop="reason">
                            <el-input placeholder="请输入请假原因" type="text" v-model="form.reason"/>
                        </el-form-item>
                    </el-descriptions-item>

                </el-descriptions>
                <div style="text-align: center;padding-top: 30px">
                    <el-button type="primary" v-on:click="onsubmit('leaveForm')">立即申请</el-button>
                </div>
            </el-form>

        </div>

        <script>

            var Main = {
                data() {
                    return {
                        employee: {}
                        , department: {}
                        , form: {
                            formType: "1",
                            timeRange: "",
                            startTime: "",
                            endTime: "",
                            reason: "",
                            eid: "",
                        },
                        // 表单验证，需要在 el-form-item 元素中增加 prop 属性
                        rules: {
                            timeRange: [
                                {required: true, message: '请选择请假时间', trigger: 'blur'}
                            ],
                            reason: [
                                {required: true, message: '请填写请假原因', trigger: 'blur'}
                            ]
                        }
                    }
                }
                , methods: {
                    changeTimeRange: function () {
                        this.form.startTime = this.form.timeRange[0].getTime();
                        this.form.endTime = this.form.timeRange[1].getTime();
                    }
                    , onsubmit: function (formName) {
                        const objApp = this;
                        const formData = this.form;
                        const $message = this.$message;
                        this.$refs[formName].validate((valid) => {
                            if (valid) {
                                const params = new URLSearchParams();
                                params.append("formType", formData.formType);
                                params.append("startTime", formData.startTime);
                                params.append("endTime", formData.endTime);
                                params.append("reason", formData.reason);
                                params.append("eid", sessionStorage.eid);
                                axios.post("/api/leave/create", params)
                                    .then(function (response) {
                                        console.info(response);
                                        const json = response.data;
                                        if (json.code == "0") {
                                            objApp.$alert("请假单已提交,等待上级审批", {
                                                callback: function () {
                                                    window.location.href = "/notice.html";
                                                }
                                            })
                                        } else {
                                            $message.error({message: json.message, offset: 100})
                                        }
                                    })
                            }
                        })
                    }
                }
                , mounted() {
                    const objApp = this;
                    const uid = sessionStorage.uid;
                    const eid = sessionStorage.eid;
                    axios.get("/api/user_info?uid=" + uid + "&eid=" + eid)
                        .then(function (response) {
                            const json = response.data;
                            objApp.employee = json.data.employee;
                            console.info(json.data);
                            objApp.department = json.data.department;
                        });
                }
            };
            ElementPlus.locale(ElementPlus.lang.zhCn);
            const app = Vue.createApp(Main);
            app.use(ElementPlus, ElementPlus.lang.zhCn);
            app.mount("#app")
        </script>
    </body>
</html>