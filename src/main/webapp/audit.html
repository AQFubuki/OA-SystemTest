<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
        <!-- 引入样式 -->
        <link href="/assets/element-plus/index.css" rel="stylesheet" type="text/css">
        <!-- 引入组件库 -->
        <script src="/assets/vue/vue.global.js"></script>
        <script src="/assets/element-plus/index.full.js"></script>
        <script src="/assets/axios/axios.js"></script>
        <style>

            .info .el-col, .info .el-select, .info .el-input {
                padding-top: 5px;
                padding-bottom: 5px;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <h2>请假审批</h2>
            <!--    ref="singleTable"-->
            <el-table
                    :data="tableData"
                    @current-change="handleCurrentChange"
                    highlight-current-row
                    ref="singleTable"
                    style="width: 100%">
                <!--        type="index" 表示序号列-->
                <el-table-column
                        type="index"
                        width="50">
                </el-table-column>
                <el-table-column
                        label="申请时间"
                        property="ctime"
                        width="180">
                </el-table-column>
                <el-table-column
                        label="类型"
                        property="ftype"
                        width="120">
                </el-table-column>
                <el-table-column
                        label="部门"
                        property="department_name"
                        width="120">
                </el-table-column>
                <el-table-column
                        label="员工"
                        property="name"
                        width="120">
                </el-table-column>
                <el-table-column
                        label="起始时间"
                        property="stime"
                        width="180">
                </el-table-column>
                <el-table-column
                        label="结束时间"
                        property="etime"
                        width="180">
                </el-table-column>
                <el-table-column
                        label="请假原因"
                        property="reason">
                </el-table-column>
            </el-table>

            <el-dialog center title="请假审批" v-model="dialogFormVisible" width="500px">
                <el-descriptions :column="2" border>
                    <el-descriptions-item label="部门">{{currentRow.department_name}}</el-descriptions-item>
                    <el-descriptions-item label="姓名">{{currentRow.name}}</el-descriptions-item>
                    <el-descriptions-item label="起始时间">{{currentRow.stime}}</el-descriptions-item>
                    <el-descriptions-item label="结束时间">{{currentRow.etime}}</el-descriptions-item>
                    <el-descriptions-item :span="2" label="请假原因">
                        {{currentRow.reason}}
                    </el-descriptions-item>
                </el-descriptions>

                <div class="info">
                    <el-form :model="form" ref="auditForm">
                        <el-select placeholder="是否同意" style="width: 100%" v-model="form.result">
                            <el-option label="同意" value="approved"></el-option>
                            <el-option label="驳回" value="refused"></el-option>
                        </el-select>
                        <el-input autocomplete="off" placeholder="请输入审批意见" v-model="form.reason"></el-input>
                    </el-form>
                    <span class="dialog-footer">
              <el-button style="width: 100%" type="primary" v-on:click="onSubmit('auditForm')">确认提交</el-button>
            </span>
                </div>
            </el-dialog>
        </div>

        <script>
            function formatDate(time) {
                var newDate = new Date(time);
                return newDate.getFullYear() + "-" +
                    (newDate.getMonth() + 1) + "-" + newDate.getDate()
                    + " " + newDate.getHours() + "时";
            };
            var Main = {
                data() {
                    return {
                        dialogFormVisible: false,
                        form: {
                            result: "approved",
                            reason: ""
                        },
                        formLabelWidth: '120px',
                        tableData: [{
                            ctime: "2021-5-29 18时",
                            ftype: "事假",
                            stime: "2021-5-31 0时",
                            etime: "2021-6-3 0时",
                            department_name: "研发部",
                            name: "王美美",
                            reason: "测试数据"
                        }],
                        currentRow: null
                    }
                }
                , methods: {
                    handleCurrentChange(val) {
                        this.currentRow = val;
                        console.info(val);
                        this.dialogFormVisible = true;
                    }
                    , onSubmit: function (formName) {
                        // formId – 表单编号
                        // operatorId – 经办人(当前登录员工)
                        // result – 审批结果
                        // reason – 审批意见
                        const objApp = this;
                        const formData = this.form;
                        const $message = this.$message;
                        this.$refs[formName].validate((valid) => {
                            if (valid) {
                                const params = new URLSearchParams();
                                params.append("formId", objApp.currentRow.form_id);
                                params.append("operatorId", sessionStorage.eid);
                                params.append("result", formData.result);
                                params.append("reason", formData.reason);
                                console.info(objApp.currentRow);
                                axios.post("/api/leave/audit", params)
                                    .then(function (response) {
                                        console.info(response);
                                        const json = response.data;
                                        if (json.code == "0") {
                                            objApp.$alert("审批意见已提交", {
                                                // 对话框点击确定后执行的操作
                                                callback: function () {
                                                    window.location.href = "/notice.html";
                                                }
                                            })
                                        } else {
                                            $message.error({message: json.message, offset: 100})
                                        }
                                    })
                            } else {
                                console.info("有问题");
                            }
                        })
                    }
                }
                , mounted() {
                    const objApp = this;
                    const $message = this.$message;
                    const eid = sessionStorage.eid;
                    axios.get("/api/leave/list?eid=" + eid)
                        .then(function (response) {
                            const json = response.data;
                            if (json.code == '0') {
                                objApp.tableData.splice(0, objApp.tableData.length);
                                const formList = json.data.list;
                                formList.forEach(function (item) {
                                        switch (item.form_type) {
                                            case 1:
                                                item.ftype = "事假";
                                                break;
                                            case 2:
                                                item.ftype = "病假";
                                                break;
                                            case 3:
                                                item.ftype = "工伤假";
                                                break;
                                            case 4:
                                                item.ftype = "婚假";
                                                break;
                                            case 5:
                                                item.ftype = "产假";
                                                break;
                                            case 6:
                                                item.ftype = "丧假";
                                                break;
                                        }
                                        item.stime = formatDate(item.start_time);
                                        item.etime = formatDate(item.end_time);
                                        item.ctime = formatDate(item.create_time);
                                        objApp.tableData.push(item);
                                    }
                                )
                            } else {
                                $message.error({message: json.message, offset: 100});
                            }
                        });
                }
            };
            const app = Vue.createApp(Main);
            app.use(ElementPlus);
            app.mount("#app")
        </script>

    </body>
</html>